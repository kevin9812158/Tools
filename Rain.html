<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>æ‰“å­—é›¨ Mobile</title>
<style>
    :root {
        --bg-color: #0d1b2a;
        --sidebar-bg: #1b263b;
        --text-color: #e0e1dd;
        --accent-color: #00b4d8;
        --danger-color: #e63946;
        --success-color: #2a9d8f;
        --input-bg: #415a77;
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        /* ä½¿ç”¨ dvh (dynamic viewport height) è§£æ±º iOS Safari ç¶²å€åˆ—é®æ“‹å•é¡Œ */
        height: 100dvh; 
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* === é ‚éƒ¨å°èˆªåˆ— (æ‰‹æ©Ÿæ–°å¢) === */
    #navbar {
        height: 50px;
        background-color: #111;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        z-index: 50;
        border-bottom: 1px solid #333;
    }
    
    #menu-btn {
        background: none;
        border: none;
        color: var(--accent-color);
        font-size: 1.5rem;
        cursor: pointer;
    }

    #game-stats-mini {
        font-size: 0.9rem;
        font-family: monospace;
        color: #ddd;
    }

    /* === å´é‚Šæ¬„ (æ”¹ç‚ºæŠ½å±œå¼) === */
    #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 85%;
        height: 100%;
        background-color: var(--sidebar-bg);
        padding: 20px;
        transform: translateX(-100%); /* é è¨­éš±è— */
        transition: transform 0.3s ease;
        z-index: 100;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    }

    #sidebar.open {
        transform: translateX(0);
    }

    /* é®ç½© */
    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 90;
        display: none;
    }
    #overlay.show { display: block; }

    /* === éŠæˆ²å€åŸŸ === */
    #game-area {
        flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #stage {
        flex: 1;
        position: relative;
        overflow: hidden;
        /* ç°¡åŒ–èƒŒæ™¯ä»¥æå‡æ‰‹æ©Ÿæ•ˆèƒ½ */
        background: linear-gradient(to bottom, #0d1b2a 0%, #1b263b 100%);
    }

    /* é›¨æ»´ */
    .word-drop {
        position: absolute;
        color: #90e0ef;
        font-size: 1.1rem; /* æ‰‹æ©Ÿå­—é«”ç¨å¾®èª¿å° */
        font-weight: bold;
        background: rgba(13, 27, 42, 0.9);
        padding: 4px 8px;
        border-radius: 4px;
        border-top: 2px solid var(--accent-color);
        z-index: 5;
        white-space: nowrap;
        /* ç¢ºä¿é»æ“Šä¸åˆ°ï¼Œé¿å…æ‰‹æ©Ÿèª¤è§¸ */
        pointer-events: none; 
    }
    .word-drop.hit { color: #fff; background: var(--success-color); opacity: 0; transform: scale(1.5); transition: 0.2s; }
    .word-drop.miss { background: var(--danger-color); }

    /* === è¼¸å…¥å€ (åº•éƒ¨å›ºå®š) === */
    #input-zone {
        padding: 10px;
        background-color: #0b131c;
        border-top: 1px solid #333;
        /* é‡è¦ï¼šç¢ºä¿éµç›¤å½ˆå‡ºæ™‚é€™è£¡æ˜¯å¯è¦‹çš„ */
        flex-shrink: 0; 
    }

    /* ä½¿ç”¨ form åŒ…è£¹ input ä»¥æ”¯æ´æ‰‹æ©Ÿéµç›¤çš„ Go/Enter */
    #game-form {
        display: flex;
        gap: 10px;
    }

    #answer-input {
        flex: 1;
        height: 45px;
        font-size: 1.2rem;
        padding: 0 10px;
        border-radius: 8px;
        border: none;
        background-color: #ecf0f1;
        color: #333;
        /* é˜²æ­¢ iOS ç¸®æ”¾ */
        font-size: 16px; 
    }
    
    #answer-input:focus {
        outline: 2px solid var(--accent-color);
    }

    /* UI å…ƒä»¶æ¨£å¼ */
    h2, h3 { color: var(--accent-color); margin-top: 15px; margin-bottom: 5px; }
    textarea { width: 100%; height: 100px; background: #222; color: #fff; border: 1px solid #555; }
    
    button {
        width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none;
        font-size: 1rem; font-weight: bold; cursor: pointer; color: white;
    }
    .btn-primary { background-color: var(--accent-color); }
    .btn-danger { background-color: var(--danger-color); }
    .btn-close { background-color: #555; margin-bottom: 20px; }

    .control-group { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    label { display: block; margin: 5px 0; font-size: 0.9rem; }
    
    #feedback-msg { margin-top:10px; padding:5px; display:none; border-radius:4px; font-size:0.9rem; }
    .success-msg { background: rgba(42, 157, 143, 0.3); color: var(--success-color); }
    .error-msg { background: rgba(230, 57, 70, 0.3); color: var(--danger-color); }

</style>
</head>
<body>

<nav id="navbar">
    <button id="menu-btn">â˜° è¨­å®š</button>
    <div id="game-stats-mini">Score: <span id="mini-score">0</span> | Lv.<span id="mini-level">1</span></div>
</nav>

<div id="overlay"></div>

<div id="sidebar">
    <button class="btn-close" id="close-menu">âœ• é—œé–‰é¸å–®</button>
    
    <h2>ğŸŒ§ï¸ è¨­å®šèˆ‡è©åº«</h2>
    
    <div class="control-group">
        <button id="btn-start" class="btn-primary">â–¶ é–‹å§‹éŠæˆ²</button>
        <button id="btn-stop" class="btn-danger" style="display:none;">â¹ åœæ­¢éŠæˆ²</button>
    </div>

    <div class="control-group">
        <h3>åˆ¤å®šè¨­å®š</h3>
        <label><input type="checkbox" id="opt-kana" checked> å‡åé€šè (ã‚=ã‚¢)</label>
        <label><input type="checkbox" id="opt-ignore-note" checked> å¿½ç•¥æ‹¬è™Ÿå‚™è¨»</label>
        <label><input type="checkbox" id="opt-multi" checked> å¤šç­”æ¡ˆ (/åˆ†éš”)</label>
    </div>

    <div class="control-group">
        <h3>è©åº«ä¾†æº</h3>
        <div>
            <label><input type="radio" name="preset" value="N5"> N5</label>
            <label><input type="radio" name="preset" value="N4"> N4</label>
            <label><input type="radio" name="preset" value="N3" checked> N3</label>
            <label><input type="radio" name="preset" value="N2"> N2</label>
            <label><input type="radio" name="preset" value="N1"> N1</label>
        </div>
        <textarea id="import-area" placeholder="è²¼ä¸Šè‡ªè¨‚å–®å­—...&#10;ä¸­æ–‡|æ—¥æ–‡"></textarea>
        <label><input type="checkbox" id="opt-merge"> åˆä½µå…§å»ºèˆ‡è‡ªè¨‚</label>
        <button id="btn-import" style="background:#444;">åŒ¯å…¥æª¢æŸ¥</button>
        <div id="feedback-msg"></div>
    </div>
</div>

<div id="game-area">
    <div id="stage"></div>
    <div id="input-zone">
        <form id="game-form" onsubmit="return false;" autocomplete="off">
            <input type="text" id="answer-input" placeholder="è¼¸å…¥æ—¥æ–‡..." enterkeyhint="go" autocapitalize="off" autocorrect="off">
        </form>
    </div>
</div>

<script>
/* === éŠæˆ²é‚è¼¯ (èˆ‡é›»è…¦ç‰ˆç›¸åŒï¼Œåƒ…å¾®èª¿ UI æ§åˆ¶) === 
*/

// è³‡æ–™èˆ‡ç‹€æ…‹
const PRESETS = {
    N5: [{q:"æˆ‘", a:["ã‚ãŸã—"]}, {q:"å­¸ç”Ÿ", a:["ãŒãã›ã„"]}, {q:"æ°´", a:["ã¿ãš"]}, {q:"åƒ", a:["ãŸã¹ã‚‹"]}, {q:"ä»€éº¼", a:["ãªã«"]}],
    N4: [{q:"æ¯”è¼ƒ", a:["ãã‚‰ã¹ã‚‹"]}, {q:"ä½æ‰€", a:["ã˜ã‚…ã†ã—ã‚‡"]}, {q:"ç‰¹åˆ¥", a:["ã¨ãã¹ã¤"]}, {q:"å±éšª", a:["ã‚ã¶ãªã„"]}],
    N3: [{q:"æ¥µå¥½çš„", a:["ã™ã¦ã"]}, {q:"æ”¾æ£„", a:["ã‚ãã‚‰ã‚ã‚‹"]}, {q:"å³ä½¿å¦‚æ­¤", a:["ãã‚Œã§ã‚‚"]}, {q:"æŠ€è¡“", a:["ãã˜ã‚…ã¤"]}],
    N2: [{q:"ä¾è³´", a:["ã„ã‚‰ã„"]}, {q:"æ°¸é ", a:["ãˆã„ãˆã‚“"]}, {q:"å½±éŸ¿", a:["ãˆã„ãã‚‡ã†"]}, {q:"å‚¾å‘", a:["ã‘ã„ã“ã†"]}],
    N1: [{q:"å£“å€’", a:["ã‚ã£ã¨ã†"]}, {q:"é‹ç”¨", a:["ã†ã‚“ã‚ˆã†"]}, {q:"ç·©å’Œ", a:["ã‹ã‚“ã‚"]}, {q:"å‡è¡¡", a:["ãã‚“ã“ã†"]}]
};

const GameState = {
    isPlaying: false,
    words: [],
    activeDrops: [],
    score: 0,
    level: 1,
    startTime: 0,
    lastFrameTime: 0,
    spawnTimer: 0
};

// DOM å…ƒç´ 
const el = {
    sidebar: document.getElementById('sidebar'),
    overlay: document.getElementById('overlay'),
    menuBtn: document.getElementById('menu-btn'),
    closeBtn: document.getElementById('close-menu'),
    stage: document.getElementById('stage'),
    input: document.getElementById('answer-input'),
    form: document.getElementById('game-form'),
    miniScore: document.getElementById('mini-score'),
    miniLevel: document.getElementById('mini-level'),
    importArea: document.getElementById('import-area'),
    feedback: document.getElementById('feedback-msg'),
    btnStart: document.getElementById('btn-start'),
    btnStop: document.getElementById('btn-stop'),
    btnImport: document.getElementById('btn-import')
};

// === æ‰‹æ©Ÿç‰ˆé¸å–®æ§åˆ¶ ===
function toggleMenu(show) {
    if (show) {
        el.sidebar.classList.add('open');
        el.overlay.classList.add('show');
    } else {
        el.sidebar.classList.remove('open');
        el.overlay.classList.remove('show');
    }
}
el.menuBtn.addEventListener('click', () => toggleMenu(true));
el.closeBtn.addEventListener('click', () => toggleMenu(false));
el.overlay.addEventListener('click', () => toggleMenu(false));

// === æ ¸å¿ƒé‚è¼¯ (å…±ç”¨) ===
function normalize(str) {
    let s = str.replace(/ã€€/g, ' ').trim();
    if (document.getElementById('opt-ignore-note').checked) {
        s = s.replace(/\([^\)]*\)/g, '').replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '');
        s = s.replace(/^[ï½ã€œ~]+/, '').replace(/[ï½ã€œ~]+$/, '');
    }
    s = s.toLowerCase();
    if (document.getElementById('opt-kana').checked) {
        s = s.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
    }
    return s.trim();
}

function checkAnswer(input, answers) {
    const nInput = normalize(input);
    return answers.some(ans => normalize(ans) === nInput && nInput !== "");
}

function prepareWords() {
    // ç°¡å–®çš„è©åº«æº–å‚™é‚è¼¯
    let presetKey = document.querySelector('input[name="preset"]:checked').value;
    let words = JSON.parse(JSON.stringify(PRESETS[presetKey] || PRESETS.N3));
    
    const rawImport = el.importArea.value.trim();
    if (rawImport) {
        const custom = rawImport.split('\n').map(line => {
            const p = line.split('|');
            if (p.length!==2) return null;
            return {q: p[0].trim(), a: p[1].split('/').map(x=>x.trim())};
        }).filter(x=>x);
        
        if (document.getElementById('opt-merge').checked) {
            words = words.concat(custom);
        } else if (custom.length > 0) {
            words = custom;
        }
    }
    return words;
}

// === éŠæˆ²å¼•æ“ ===
function startGame() {
    // é—œé–‰é¸å–®ï¼Œè®“ç©å®¶çœ‹åˆ°ç•«é¢
    toggleMenu(false);
    
    GameState.words = prepareWords();
    if(GameState.words.length === 0) { alert("ç„¡å–®å­—è³‡æ–™"); return; }

    GameState.isPlaying = true;
    GameState.score = 0;
    GameState.level = 1;
    GameState.startTime = Date.now();
    GameState.lastFrameTime = Date.now();
    GameState.activeDrops = [];
    
    el.stage.innerHTML = '';
    el.input.value = '';
    el.input.focus(); // æ‰‹æ©Ÿä¸Šé€™æœƒå«å‡ºéµç›¤
    
    el.btnStart.style.display = 'none';
    el.btnStop.style.display = 'block';

    requestAnimationFrame(gameLoop);
}

function stopGame() {
    GameState.isPlaying = false;
    el.btnStart.style.display = 'block';
    el.btnStop.style.display = 'none';
    alert(`éŠæˆ²çµæŸï¼å¾—åˆ†: ${GameState.score}`);
}

function gameLoop() {
    if (!GameState.isPlaying) return;
    
    const now = Date.now();
    const dt = now - GameState.lastFrameTime;
    GameState.lastFrameTime = now;
    
    // é›£åº¦è¨­å®š
    const timeFactor = Math.min((now - GameState.startTime) / 60000, 5);
    GameState.spawnTimer += dt;
    
    // ç”Ÿæˆ (æ‰‹æ©Ÿç‰ˆç”Ÿæˆç¨å¾®æ…¢ä¸€é»ï¼Œé¿å…ç•«é¢å¤ªäº‚)
    if (GameState.spawnTimer > Math.max(2500 - (timeFactor*400), 800)) {
        spawnDrop();
        GameState.spawnTimer = 0;
    }

    // ç§»å‹•
    const baseSpeed = 80; // æ‰‹æ©Ÿç‰ˆé€Ÿåº¦ç¨æ…¢
    const speedMult = 1 + (timeFactor * 0.4);
    const limitY = el.stage.clientHeight;

    // åå‘è¿´åœˆä»¥åˆ©åˆªé™¤
    for (let i = GameState.activeDrops.length - 1; i >= 0; i--) {
        let d = GameState.activeDrops[i];
        d.y += baseSpeed * speedMult * dt / 1000;
        d.el.style.transform = `translateY(${d.y}px)`;
        
        if (d.y > limitY - 20) {
            d.el.classList.add('miss');
            GameState.activeDrops.splice(i, 1);
            GameState.score = Math.max(0, GameState.score - 5);
            updateUI();
            setTimeout(()=>d.el.remove(), 200);
        }
    }

    requestAnimationFrame(gameLoop);
}

function spawnDrop() {
    const w = GameState.words[Math.floor(Math.random() * GameState.words.length)];
    const div = document.createElement('div');
    div.classList.add('word-drop');
    div.textContent = w.q;
    
    // æ‰‹æ©Ÿå¯¬åº¦éš¨æ©Ÿ (ç•™é‚Šè·)
    const maxX = el.stage.clientWidth - 80;
    div.style.left = Math.random() * maxX + 'px';
    div.style.top = '0px';
    
    el.stage.appendChild(div);
    GameState.activeDrops.push({el: div, data: w, y: -30});
}

function updateUI() {
    el.miniScore.textContent = GameState.score;
    // æ¯ 30 ç§’å‡ä¸€ç´š
    const lv = Math.floor((Date.now() - GameState.startTime)/30000) + 1;
    el.miniLevel.textContent = lv;
}

// === è¼¸å…¥è™•ç† (æ‰‹æ©Ÿéµç›¤å„ªåŒ–) ===
// ç›£è½ Form Submit (å°æ‡‰æ‰‹æ©Ÿéµç›¤çš„ Go/Enter)
el.form.addEventListener('submit', (e) => {
    e.preventDefault(); // é˜²æ­¢åˆ·æ–°
    const val = el.input.value;
    if(!val) return;

    let hit = false;
    // å„ªå…ˆæ¯”å°æœ€ä¸‹é¢çš„é›¨æ»´
    GameState.activeDrops.sort((a,b) => b.y - a.y);
    
    for (let i=0; i<GameState.activeDrops.length; i++) {
        if (checkAnswer(val, GameState.activeDrops[i].data.a)) {
            const drop = GameState.activeDrops[i];
            drop.el.classList.add('hit');
            GameState.activeDrops.splice(i, 1);
            setTimeout(()=>drop.el.remove(), 200);
            
            GameState.score += 10;
            updateUI();
            hit = true;
            break;
        }
    }

    if (hit) {
        el.input.value = ''; // ç­”å°æ‰æ¸…ç©º
    } else {
        el.input.style.backgroundColor = '#5c2b29'; // éŒ¯èª¤æç¤º
        setTimeout(()=>el.input.style.backgroundColor = '#ecf0f1', 150);
        // æ‰‹æ©Ÿä¸Šé€šå¸¸å…¨é¸æ¯”è¼ƒå¥½ä¿®æ”¹
        el.input.select(); 
    }
});

// åŒ¯å…¥æŒ‰éˆ•ç°¡å–®é‚è¼¯
el.btnImport.addEventListener('click', () => {
    if(el.importArea.value) {
        el.feedback.textContent = "âœ… å·²æš«å­˜";
        el.feedback.style.display = 'block';
        el.feedback.className = 'success-msg';
        localStorage.setItem('mobile-rain-custom', el.importArea.value);
    }
});

// Init
el.btnStart.addEventListener('click', startGame);
el.btnStop.addEventListener('click', stopGame);
if(localStorage.getItem('mobile-rain-custom')) {
    el.importArea.value = localStorage.getItem('mobile-rain-custom');
}

</script>
</body>
</html>